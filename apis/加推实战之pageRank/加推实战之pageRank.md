## åŠ æ¨å®æˆ˜ä¹‹pageRank

> PageRankæ˜¯é€šè¿‡è®¡ç®—é¡µé¢é“¾æ¥çš„æ•°é‡å’Œè´¨é‡æ¥ç¡®å®šç½‘ç«™é‡è¦æ€§çš„ç²—ç•¥ä¼°è®¡

### æ–¹æ³•èƒŒæ™¯åŠåº”ç”¨æ¦‚è¿°

> PageRankç®—æ³•åœ¨1998å¹´4æœˆä¸¾è¡Œçš„ç¬¬ä¸ƒå±Šå›½é™…ä¸‡ç»´ç½‘å¤§ä¼šä¸Šç”±Sergey Brinå’ŒLarry Pageæå‡ºã€‚æ‰€ä»¥å«pageRankğŸ˜„
>
> ç®—æ³•åˆ›ç«‹ä¹‹åˆçš„ç›®çš„æ˜¯åº”ç”¨åœ¨Googleçš„æœç´¢å¼•æ“ä¸­ï¼Œå¯¹ç½‘ç«™è¿›è¡Œæ’åã€‚
>
> ä½œä¸ºå…¸å‹çš„æŠ€æœ¯é©±åŠ¨å‹çš„å…¬å¸ï¼ŒGoogleç¡®å®æ”¹å˜äº†ä¸–ç•ŒğŸ’¥

* ä¸ºäº†æé«˜æœç´¢è´¨é‡ï¼Œå¼€å§‹ä½¿ç”¨äººå·¥è¿›è¡Œç›®å½•åˆ†ç±»ï¼Œç½‘é¡µè¶Šæ¥è¶Šå¤šï¼Œäººå·¥åˆ†ç±»å·²ç»ä¸ç°å®äº†ã€‚æœç´¢å¼•æ“è¿›å…¥äº† **æ–‡æœ¬æ£€ç´¢** çš„æ—¶ä»£ã€‚
* è°·æ­Œçš„ä¸¤ä½åˆ›å§‹äººï¼Œå€Ÿé‰´äº†å­¦æœ¯ç•Œè¯„åˆ¤å­¦æœ¯è®ºæ–‡é‡è¦æ€§æ–¹æ³•ï¼Œ è®ºæ–‡è¢«å¼•ç”¨æ¬¡æ•°ã€‚ç”±æ­¤æƒ³åˆ°ç½‘é¡µçš„é‡è¦æ€§ä¹Ÿå¯ä»¥æ ¹æ®è¿™ç§æ–¹æ³•æ¥è¯„ä»·ã€‚
* ä½œä¸ºç°ä»£æœç´¢å¼•æ“çš„æ ¸å¿ƒç®—æ³•ï¼Œå¤§å®¶åº”è¯¥éƒ½äº†è§£ä¸€ä¸‹ã€‚å¸¸ç”¨çš„å¤§æ•°æ®ç®—æ³•åº“ä¸€èˆ¬éƒ½åŒ…å«æ­¤æ–¹æ³•
* åœ¨ç¤¾äº¤ç½‘ç»œä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç±»ä¼¼çš„æ‰¾å‡ºä»·å€¼å…±äº«æœ€å¤§çš„äººï¼ˆèŠ‚ç‚¹ï¼‰ğŸ˜„
* åœ¨ä¸€æ®µæ—¶é—´å†…ï¼ŒpageRankä½œä¸ºç½‘é¡µè¥é”€çš„ä¸€ä¸ªè¡¡é‡æ ‡å‡†ï¼Œå½“ç„¶ç°åœ¨äººä»¬æ”¹å˜äº†æƒ³æ³•
* å»¶å±•çš„æ–¹æ³•æœ‰ [TrustRank](https://baike.baidu.com/item/TrustRank)ï¼Œ[Hilltop](https://baike.baidu.com/item/Hilltop) ç®—æ³•ç­‰

### ç®—æ³•æ ¸å¿ƒæ€æƒ³

* **å¦‚æœä¸€ä¸ªç½‘é¡µè¢«å¾ˆå¤šå…¶ä»–ç½‘é¡µé“¾æ¥åˆ°çš„è¯è¯´æ˜è¿™ä¸ªç½‘é¡µæ¯”è¾ƒé‡è¦ï¼Œä¹Ÿå°±æ˜¯PageRankå€¼ä¼šç›¸å¯¹è¾ƒé«˜**
* **å¦‚æœä¸€ä¸ªPageRankå€¼å¾ˆé«˜çš„ç½‘é¡µé“¾æ¥åˆ°ä¸€ä¸ªå…¶ä»–çš„ç½‘é¡µï¼Œé‚£ä¹ˆè¢«é“¾æ¥åˆ°çš„ç½‘é¡µçš„PageRankå€¼ä¼šç›¸åº”åœ°å› æ­¤è€Œæé«˜**ğŸ˜„
* æ‰€è°“ç¯ç¯ç›¸æ‰£

### æ•°å­¦æ¦‚å¿µå‡†å¤‡

##### å…ˆå®ç°é©¬å°”ç§‘å¤«çŸ©é˜µçš„åˆ¤æ–­ï¼ˆéšæœºçŸ©é˜µã€æ¦‚ç‡çŸ©é˜µï¼‰

> é©¬å°”ç§‘å¤«çŸ©é˜µåˆ¤æ–­æ ‡å‡†ï¼šæ‰€æœ‰å…ƒç´ éƒ½>=0ï¼Œå¹¶ä¸”æ¯ä¸€åˆ—çš„å…ƒç´ å’Œéƒ½ä¸º1

```javascript
function isMarkov (mat) {
  let esp = 1e-10 // å’Œ1çš„è¯¯å·®
  let isPositive = !1
  let colSum = [] // æ¯1åˆ—æ±‚å’Œ
  let len = mat.length
  for (let i = 0; i < len; i++) {
    for (let k = 0; k < len; k++) {
      const item = mat[i][k]
      isPositive = item >= 0 ? !0 : !1
      if (!isPositive) return !1
      colSum[k] = colSum[k] || 0
      colSum[k] += item
    }
  }
  return colSum.every(x => Math.abs(1 - x) <= esp) && isPositive
}
```

* å½“ç„¶è¿˜éœ€è¦2ä¸ªæ¡ä»¶
* éšæœºçŸ©é˜µå¿…é¡»æ˜¯ä¸å¯çº¦çŸ©é˜µï¼ˆè‡ªè¡Œå­¦ä¹ ï¼‰
* éšæœºçŸ©é˜µå¿…é¡»æ˜¯éå‘¨æœŸçš„ï¼ˆè‡ªè¡Œå­¦ä¹ ï¼‰
* åŒ…æ‹¬æ”¶æ•›æ€§ï¼Œé«˜æ–¯-èµ›å¾·å°”è¿­ä»£
* æœ€ç»ˆï¼Œè¯æ˜äº†PageRankç®—æ³•çš„æ­£ç¡®æ€§ã€‚ğŸ˜„

##### äº†è§£é«˜æ–¯-å¡å¾·å°”è¿­ä»£æ³•

* é«˜æ–¯-èµ›å¾·å°”è¿­ä»£æ³•æ˜¯è§£**çº¿æ€§æ–¹ç¨‹ç»„**çš„å¸¸ç”¨è¿­ä»£æ³•ä¹‹ä¸€ï¼Œè®¾çº¿æ€§æ–¹ç¨‹ç»„ä¸º
  $$
  \begin{array}{c}
  a_{i 1} x_{1}+a_{i 2} x_{2}+\cdots+a_{i n} x_{n}=b_{i} \\
  (i=1,2, \cdots, n)
  \end{array}
  $$
  
* é«˜æ–¯-èµ›å¾·å°”è¿­ä»£æ³•çš„è¿­ä»£å…¬å¼ä¸º:

$$
\begin{aligned}
x_{i}^{(k+1)}=(&\left.b_{i}-\sum_{j=1}^{i-1} a_{i j} x_{j}^{(k+1)}-\sum_{j=i+1}^{n} a_{i j} x_{j}^{(k)}\right.) / a_{i i} \\
&(i=1,2, \cdots, n ; k=0,1,2, \cdots,)
\end{aligned}
$$

* é€šè¿‡ä¸æ–­è¿­ä»£ï¼Œæœ€ç»ˆè§£å‡ºç‰¹å¾å‘é‡ï¼Œä¹Ÿå°±æ˜¯ç½‘é¡µçš„ä»·å€¼å‘é‡PR

### å…ˆæ¥çœ‹ä¸€ä¸ªå…·ä½“ä¾‹å­

![pr01](pr01.png)

* A æœ‰ 2 ä¸ªå…¥é“¾ï¼Œ3 ä¸ªå‡ºé“¾ï¼ŒB ,C , Dä¾æ¬¡ç±»æ¨

* å°†è¿™ä¸ªç½‘ç»œå†™æˆæ¦‚ç‡çŸ©é˜µï¼Œä¹Ÿå°±æ˜¯**é©¬å°”ç§‘å¤«çŸ©é˜µ**

* $$
  M=\left[\begin{array}{cccc}
  0 & 1 / 2 & 1 & 0 \\
  1 / 3 & 0 & 0 & 1 / 2 \\
  1 / 3 & 0 & 0 & 1 / 2 \\
  1 / 3 & 1 / 2 & 0 & 0
  \end{array}\right]
  $$

* æˆ‘æ¥è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„çŸ©é˜µï¼š

* ä¸€åˆ—ä¸€åˆ—çœ‹ï¼ŒAåˆ—å‘é‡ï¼ŒBåˆ—å‘é‡ï¼ŒCåˆ—å‘é‡ï¼ŒDåˆ—å‘é‡

* A æœ‰ä¸‰ä¸ªå‡ºé“¾åˆ†åˆ«é“¾æ¥åˆ°äº† Bã€Cã€D ä¸Šã€‚é‚£ä¹ˆå½“ç”¨æˆ·è®¿é—® A çš„æ—¶å€™ï¼Œå°±æœ‰è·³è½¬åˆ° Bã€C æˆ–è€… D çš„å¯èƒ½æ€§ï¼Œè·³è½¬æ¦‚ç‡å„ä¸º 1/3ã€‚

* B æœ‰ä¸¤ä¸ªå‡ºé“¾ï¼Œé“¾æ¥åˆ°äº† A å’Œ D ä¸Šï¼Œè·³è½¬æ¦‚ç‡å„ä¸º 1/2ã€‚

* C=>A ,D=>B,D=>C å¾ˆç®€å•å§ğŸ˜„

* å› ä¸º4ä¸ªé¡µé¢çš„åˆå§‹ä»·å€¼æ˜¯ç›¸ç­‰çš„ï¼Œå…¨éƒ¨è®¾ç½®ä¸º1/4

* ç„¶åå¼€å§‹è¿›è¡ŒçŠ¶æ€è½¬ç§»ï¼Œä¸æ–­çš„ä¹˜ä»¥è½¬ç§»çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯ä¹˜ä»¥ä¸€ä¸ªåˆ—å‘é‡ã€‚å¦‚ä¸‹

* $$
  w_{1}=M w_{0}=\left[\begin{array}{cccc}
  0 & 1 / 2 & 1 & 0 \\
  1 / 3 & 0 & 0 & 1 / 2 \\
  1 / 3 & 0 & 0 & 1 / 2 \\
  1 / 3 & 1 / 2 & 0 & 0
  \end{array}\right]\left[\begin{array}{c}
  1 / 4 \\
  1 / 4 \\
  1 / 4 \\
  1 / 4
  \end{array}\right]=\left[\begin{array}{c}
  9 / 24 \\
  5 / 24 \\
  5 / 24 \\
  5 / 24
  \end{array}\right]
  $$

* ä¸æ–­ç”¨Mæˆ Wk,ä¸€ç›´åˆ°è¯¯å·®å°äºæŸä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯æ”¶æ•›äº†å³å¯åœæ­¢ã€‚

* ä»£ç ä¹Ÿå°±æ˜¯ä¸€ä¸ªå¾ªç¯å°±æå®šäº†ğŸ”¥

##### å®é™…ä¼šç¢°åˆ°çš„2ä¸ªé—®é¢˜

* 1.ç­‰çº§æ³„éœ²ï¼ˆRank Leakï¼‰åªæœ‰å…¥é“¾æ²¡æœ‰å‡ºé“¾æœ€ç»ˆæ¯ä¸ªç½‘é¡µçš„PR=0

* ![pr02](pr02.png)

* 2.ç­‰çº§æ²‰æ²¡ï¼ˆRank Sinkï¼‰å¦‚æœç½‘é¡µåªæœ‰å‡ºé“¾ï¼Œæ²¡æœ‰å…¥é“¾ï¼Œä¹Ÿä¼šè®©æ‰€æœ‰PR=0

* ![pr03](pr03.png)

* è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œå¢åŠ ä¸€ä¸ªé˜»å°¼å› å­ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æœ‰ä¸€å®šçš„æ¦‚ç‡ç›´æ¥è·³åˆ°è¿™ä¸ªé¡µé¢ï¼Œè€Œä¸æ˜¯é€šè¿‡å…¶ä»–é¡µé¢è¿‡æ¥ã€‚å…¬å¼å¦‚ä¸‹ï¼š

* $$
  PR(u)=\frac{1-d}{N}+d \sum_{i \in B_{u}} \frac{P R(v)}{L(v)}
  $$

* dä¸€èˆ¬å–0.85ï¼ŒpageRankåœ¨å´å†›çš„ã€Šæ•°å­¦ä¹‹ç¾3ã€‹æœ‰ä»‹ç»ï¼Œä½†é‡Œé¢æ²¡æœ‰æåŠå…·ä½“çš„é˜»å°¼æ•°å€¼ã€‚

* è¿™æ ·ä»£ç å°±å˜æˆï¼Œä¸æ–­å¾ªç¯ä¹˜çŸ©é˜µå¹¶å¢åŠ é˜»å°¼ç³»æ•°d

### å·¥ç¨‹å®ç°ä¸Šçš„æŠ€å·§

* å¦‚æœåªæ˜¯å®ç°è¿™ä¸ªç®—æ³•ï¼ŒSO EASYï¼Œä½†æ¯æ¬¡éƒ½è¦äººå·¥å»ç¼–å†™è¿™ä¸ªæ¦‚ç‡çŸ©é˜µæœªå…æœ‰äº›éº»çƒ¦

* å¯¹äºä¸Šå›¾ï¼Œæˆ‘ä»¬å…¶å®å¸Œæœ›è¾“å…¥è¾¹çš„æ•°ç»„ï¼Œç„¶åè‡ªåŠ¨ç”ŸæˆçŸ©é˜µ

* ![pr04](pr04.png)

* ```
  [["A", "B"], ["A", "C"], ["A", "D"], ["B", "A"], ["B", "D"], ["C", "A"], ["D", "B"], ["D", "C"]] => è‡ªåŠ¨å¾—å‡ºæ¦‚ç‡çŸ©é˜µ
  ```
  
* èŠ‚ç‚¹A-Zç”¨å®Œäº†ï¼Œå°±AA ABï¼Œå¤§å®¶å‘ç°å…¶å®è¿™å°±æ˜¯ excelçš„ å­—æ¯ç¼–ç ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹è¿™ä¸ªç®—æ³•çš„åŒå‘è¿‡ç¨‹

```javascript
const $  = require('meeko')

// ç±»excelï¼Œçš„åˆ—åæ ‡è½¬æ•°å€¼
function strIndex2num (str) {
  str = str.toUp()
  let a = str.split('')
  let len = a.length
  let s = 0
  for (let i = 0; i < len; i++) {
    s += (a[len - 1 - i].charCodeAt() - 64) * 26 ** i
  }
  return s
}
// AP =>  42

// ç±»excelï¼Œçš„åˆ—æ•°å€¼åæ ‡è½¬å­—ç¬¦ä¸²åæ ‡
function num2IndexStr (num) {
  return num
    .toString(26)
    .split('')
    .map(x => String.fromCharCode(+x ? +x + 64 : x.charCodeAt() - 23))
    .join('')
}

// 42 => AP
```

* æœ‰äº†è¿™äº›å·¥å…·æˆ‘ä»¬å°±å¯ä»¥æ„‰å¿«çš„å®ç°PageRankäº†ğŸ˜„

### JSæ‰‹æ’•PageRank

* ![image-20200924174134296](pr05.png)
* ä»¥ä¸Šæœ‰5ä¸ªèŠ‚ç‚¹ï¼Œä¸ŠpageRankå®Œæ•´ä»£ç 

```javascript
function pageRank (transMat, initVector, damping = 0.85, iter = 100) {//è¾“å…¥çš„æ¦‚ç‡çŸ©é˜µï¼Œåˆå§‹å‘é‡ï¼Œé˜»å°¼ç³»æ•°ï¼Œé«˜æ–¯-èµ›å¾·å°”è¿­ä»£æ¬¡æ•°
  const esp = 1e-9
  const len = transMat.length
  if (!isMarkov(transMat)) return { iter: 0, r: transMat, isMarkov: false } // é©¬å°”ç§‘å¤«çŸ©é˜µåˆ¤æ–­ï¼Œå…ƒç´ éè´Ÿï¼Œåˆ—å’Œä¸º1
  if (!initVector)
    // åˆå§‹åŒ–å‘é‡
    initVector = $.math.mat.transpose([
      Array.from({ length: len }, x => 1 / len) // åˆå§‹åŒ–Nä¸ªï¼Œå€¼ä¸º1/N çš„å‘é‡
    ])
  let r = $.math.mat.mul(transMat, initVector)// ç¬¬ä¸€æ¬¡è¿ç§»è®¡ç®—
  // é«˜æ–¯-å¡å¾·å°”è¿­ä»£æ³•
  for (let i = 0; i < iter; i++) {
    let weightNew = $.math.mat
      .mul(transMat, r) // ç‚¹ä¹˜ä¸Šä¸€æ¬¡ç»“æœ
      .map(x => [(1 - damping) / len + damping * x[0]]) // åŠ å…¥é˜»å°¼ç³»æ•°è®¡ç®—PR
    // è¿­ä»£ï¼Œæ”¶æ•›åˆ°é˜€å€¼åœæ­¢
    if (Math.abs(weightNew[0][0] - r[0][0]) < esp) {
      return { iter: i, r: r, isMarkov: true }
    }
    r = weightNew
  }
  return { iter: iter, r: r, isMarkov: true }
}

function createNetwork (edges) {
  /*
    edges: [ä»å“ªé‡Œ=> è·³è½¬åˆ°å“ªé‡Œ ]
  */
  let colCount = edges.map(x => x[0]).count() //è®¡ç®—åˆ—çš„æ€»è®¡æ•°
  let len = 0
  for (let i in colCount) {
    len++
  }
  let mat = $.math.mat.zero(len, len) // len * lençš„å…¨é›¶çŸ©é˜µ
  // è¾¹å­—ç¬¦ä¸²å½¢å¼è½¬ æ•°å€¼çŸ©é˜µå½¢å¼
  for (let i = 0; i < edges.length; i++) {
    let [colNum, rowNum] = [
      strIndex2num(edges[i][0]) - 1, // ç±»excel åˆ—åæ ‡ è½¬æ¢ AP =>  42
      strIndex2num(edges[i][1]) - 1
    ]
    mat[rowNum][colNum] = 1 / colCount[edges[i][0]] //1/åˆ—è®¡æ•° ä½œä¸ºåˆå§‹å€¼ æ¦‚ç‡å€¼å¡«å…¥
  }
  return mat
}
// ä¸Šå›¾çš„ä¾‹å­ï¼Œå°å†™å­—ç¬¦ä¼šè‡ªåŠ¨è½¬æˆå¤§å†™
let edges = [
  ['a', 'b'],
  ['a', 'c'],
  ['a', 'd'],
  ['b', 'd'],
  ['c', 'e'],
  ['d', 'e'],
  ['b', 'e'],
  ['e', 'a']
]
// ç”¨è¾¹å½¢å¼ åˆ›å»º é©¬å°”ç§‘å¤«æ¦‚ç‡çŸ©é˜µï¼Œè®¡ç®—pageRankå‘é‡
let pageRankArr = pageRank(createNetwork(edges)).r

console.log('pageRank:', pageRankArr)
console.log(
  'maxValueNode:',
  num2IndexStr(+$.math.findMax(pageRankArr.flatten()).tag + 1)
)
```

* è¿è¡Œç»“æœå¦‚ä¸‹
* ![image-20200924175432618](pr06.png)
* ç°å®ä¸­ï¼Œç½‘é¡µçš„èŠ‚ç‚¹çš„æ¯”è¾ƒæ˜¯ä¸Šäº¿çš„ï¼Œè€Œä¸æ˜¯åªæœ‰5ä¸ª
* æ‰€ä»¥æˆ‘ä»¬ä¼šä½¿ç”¨MapReduceå°†çŸ©é˜µè¿›è¡Œåˆ†è§£ï¼Œåˆ†è€Œæ²»ä¹‹æ³•

### PageRankç®—æ³•çš„ç¼ºç‚¹

> pageRankç®—æ³•ï¼ŒåŸç†ç®€å•ä½†æ•ˆæœæƒŠäººã€‚ç„¶è€Œï¼ŒPageRankç®—æ³•è¿˜æ˜¯æœ‰ä¸€äº›å¼Šç«¯ã€‚

* 1ï¼Œ**æ²¡æœ‰åŒºåˆ†ç«™å†…å¯¼èˆªé“¾æ¥**ã€‚å¾ˆå¤šç½‘ç«™çš„é¦–é¡µéƒ½æœ‰å¾ˆå¤šå¯¹ç«™å†…å…¶ä»–é¡µé¢çš„é“¾æ¥ï¼Œç§°ä¸ºç«™å†…å¯¼èˆªé“¾æ¥ã€‚è¿™äº›é“¾æ¥ä¸ä¸åŒç½‘ç«™ä¹‹é—´çš„é“¾æ¥ç›¸æ¯”ï¼Œè‚¯å®šæ˜¯åè€…æ›´èƒ½ä½“ç°PageRankå€¼çš„ä¼ é€’å…³ç³»ã€‚

* 2ï¼Œ**æ²¡æœ‰è¿‡æ»¤å¹¿å‘Šé“¾æ¥å’ŒåŠŸèƒ½é“¾æ¥**ï¼ˆä¾‹å¦‚å¸¸è§çš„â€œåˆ†äº«åˆ°å¾®åšâ€ï¼‰ã€‚è¿™äº›é“¾æ¥é€šå¸¸æ²¡æœ‰ä»€ä¹ˆå®é™…ä»·å€¼ï¼Œå‰è€…é“¾æ¥åˆ°å¹¿å‘Šé¡µé¢ï¼Œåè€…å¸¸å¸¸é“¾æ¥åˆ°æŸä¸ªç¤¾äº¤ç½‘ç«™é¦–é¡µã€‚

* 3ï¼Œ**å¯¹æ–°ç½‘é¡µä¸å‹å¥½**ã€‚ä¸€ä¸ªæ–°ç½‘é¡µçš„ä¸€èˆ¬å…¥é“¾ç›¸å¯¹è¾ƒå°‘ï¼Œå³ä½¿å®ƒçš„å†…å®¹çš„è´¨é‡å¾ˆé«˜ï¼Œè¦æˆä¸ºä¸€ä¸ªé«˜PRå€¼çš„é¡µé¢ä»éœ€è¦å¾ˆé•¿æ—¶é—´çš„æ¨å¹¿ã€‚

> pageRankä»£ç åœ°å€ https://github.com/kongnet/meeko/blob/master/sample/pageRank%E4%BE%8B%E5%AD%90.js


### æ€»ç»“

* äº†è§£PageRankï¼Œåº”ç”¨åˆ°å®é™…ä¸šåŠ¡åœºæ™¯

* é€šè¿‡JSå®ç°ä¹‹ï¼Œè§£å†³æ›´å¤šç±»ä¼¼çš„ç½‘ç»œä»·å€¼é—®é¢˜ğŸ”¥




ç¥å¤§å®¶2020æå‡æŠ€æœ¯ï¼Œå¼€å¿ƒï¼Œæå‡è‡ªå·± ğŸ˜„